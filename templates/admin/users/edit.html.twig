<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Edit {{ user.display_name }} · Admin · aavion Studio</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 0; padding: 2rem; background: #f5f7fb; color: #111827; }
        h1 { margin-top: 0; }
        .card { background: #fff; padding: 1.75rem; border-radius: 12px; box-shadow: 0 18px 36px rgba(15,23,42,.08); max-width: 720px; margin-bottom: 1.5rem; }
        label { display: block; font-weight: 600; margin-bottom: .35rem; }
        input[type="text"] { width: 100%; padding: .7rem 1rem; border-radius: 10px; border: 1px solid #cbd5f5; margin-bottom: 1rem; }
        select { padding: .7rem 1rem; border-radius: 10px; border: 1px solid #cbd5f5; width: 100%; margin-bottom: 1rem; }
        .roles { display: grid; gap: .5rem; margin-bottom: 1.25rem; }
        .roles label { display: flex; align-items: center; gap: .6rem; font-weight: 500; }
        .roles input { width: 16px; height: 16px; }
        button { padding: .75rem 1.5rem; border: none; border-radius: 10px; background: linear-gradient(135deg, #2563eb, #1d4ed8); color: #fff; font-weight: 600; cursor: pointer; }
        .button-secondary { background: #fff; border: 1px solid #cbd5f5; color: #1d4ed8; }
        .meta { margin-bottom: 1.5rem; color: #6b7280; font-size: .9rem; }
        a.back { display: inline-block; margin-bottom: 1.5rem; color: #2563eb; text-decoration: none; font-weight: 600; }
        .flash-success { margin-bottom: 1rem; padding: .75rem 1rem; border-radius: 10px; background: rgba(34,197,94,.1); color: #15803d; }
        .flash-error { margin-bottom: 1rem; padding: .75rem 1rem; border-radius: 10px; background: rgba(239,68,68,.1); color: #b91c1c; }
        .field { margin-bottom: 1.25rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { text-align: left; padding: .75rem; border-bottom: 1px solid #e5e7eb; }
        .tag { display: inline-block; padding: .2rem .55rem; border-radius: 999px; font-size: .75rem; background: #e0f2fe; color: #05558a; letter-spacing: .04em; }
        .grid { display: grid; gap: 1.5rem; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    </style>
</head>
<body>
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="flash-{{ label }}">{{ message }}</div>
        {% endfor %}
    {% endfor %}

    <a class="back" href="{{ path('admin_users_index') }}">← Back to users</a>

    <div class="grid">
        <div class="card">
            <h1>Edit user</h1>
            <p class="meta">
                Email: <strong>{{ user.email }}</strong><br>
                Created: {{ user.created_at ? user.created_at|date('Y-m-d H:i') : '—' }}<br>
                Last updated: {{ user.updated_at ? user.updated_at|date('Y-m-d H:i') : '—' }}
            </p>

            {{ form_start(form) }}
                <div class="field">
                    {{ form_label(form.display_name) }}
                    {{ form_widget(form.display_name) }}
                    {{ form_errors(form.display_name) }}
                </div>
                <div class="field">
                    {{ form_label(form.locale) }}
                    {{ form_widget(form.locale) }}
                    {{ form_errors(form.locale) }}
                </div>
                <div class="field">
                    {{ form_label(form.timezone) }}
                    {{ form_widget(form.timezone) }}
                    {{ form_errors(form.timezone) }}
                </div>
                <div class="field">
                    {{ form_label(form.status) }}
                    {{ form_widget(form.status) }}
                    {{ form_errors(form.status) }}
                </div>
                <div class="field">
                    <label>Roles</label>
                    <div class="roles">
                        {{ form_widget(form.roles) }}
                    </div>
                    {{ form_errors(form.roles) }}
                </div>
                <button type="submit">Save changes</button>
            {{ form_end(form) }}
        </div>

        <div class="card">
            <h2>API keys</h2>
            <p class="meta">Generate scoped API keys for integrations. Secrets are shown once—store them securely.</p>

            {{ form_start(apiKeyForm) }}
                <div class="field">
                    {{ form_label(apiKeyForm.label) }}
                    {{ form_widget(apiKeyForm.label) }}
                    {{ form_errors(apiKeyForm.label) }}
                </div>
                <div class="field">
                    {{ form_label(apiKeyForm.scopes) }}
                    {{ form_widget(apiKeyForm.scopes) }}
                    {{ form_errors(apiKeyForm.scopes) }}
                </div>
                <div class="field">
                    {{ form_label(apiKeyForm.expires_at) }}
                    {{ form_widget(apiKeyForm.expires_at) }}
                    {{ form_errors(apiKeyForm.expires_at) }}
                </div>
                <button type="submit">Create API key</button>
            {{ form_end(apiKeyForm) }}

            {% if apiKeys is not empty %}
                <table>
                    <thead>
                        <tr>
                            <th>Label</th>
                            <th>Scopes</th>
                            <th>Created</th>
                            <th>Status</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for key in apiKeys %}
                            <tr>
                                <td>{{ key.label }}</td>
                                <td>
                                    {% if key.scopes is empty %}
                                        <span class="tag" style="background:#f5f3ff;color:#4c1d95;">read-only</span>
                                    {% else %}
                                        {% for scope in key.scopes %}
                                            <span class="tag">{{ scope }}</span>
                                        {% endfor %}
                                    {% endif %}
                                </td>
                                <td>{{ key.createdAt|date('Y-m-d H:i') }}</td>
                                <td>
                                    {% if key.revokedAt %}
                                        <span class="tag" style="background:#fee2e2;color:#b91c1c;">revoked</span>
                                    {% elseif key.expiresAt and key.expiresAt < date() %}
                                        <span class="tag" style="background:#fef3c7;color:#92400e;">expired</span>
                                    {% elseif key.isActive %}
                                        <span class="tag" style="background:#dcfce7;color:#166534;">active</span>
                                    {% else %}
                                        <span class="tag">inactive</span>
                                    {% endif %}
                                </td>
                                <td style="text-align:right;">
                                    {% if key.revokedAt is null %}
                                        <form method="post" action="{{ path('admin_users_api_keys_revoke', { userId: user.id, apiKeyId: key.id }) }}" style="display:inline;">
                                            <input type="hidden" name="_token" value="{{ csrf_token('revoke_api_key_' ~ key.id) }}">
                                            <button class="button-secondary" type="submit">Revoke</button>
                                        </form>
                                    {% else %}
                                        <small>{{ key.revokedAt|date('Y-m-d H:i') }}</small>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="meta">No API keys issued yet.</p>
            {% endif %}
        </div>
    </div>
</body>
</html>
