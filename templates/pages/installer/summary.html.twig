{% extends 'layouts/installer.html.twig' %}

{% block content %}
    {% include 'partials/components/section_heading.html.twig' with {
        title: 'Summary'|trans,
        subtitle: 'Review your selections before the installer provisions databases, writes configuration, and locks the wizard.'|trans
    } only %}

    <div class="grid gap-6 lg:grid-cols-[minmax(0,3fr)_minmax(0,2fr)]">
        <div class="layout-stack layout-stack--loose">
            {% set environment_body %}
                <dl class="grid gap-2 text-sm leading-relaxed text-text-muted">
                    <div class="flex items-center justify-between gap-4">
                        <dt class="font-semibold text-text">{{ 'Instance name'|trans }}</dt>
                        <dd>{{ environment_settings['core.instance_name'] ?? '–' }}</dd>
                    </div>
                    <div class="flex items-center justify-between gap-4">
                        <dt class="font-semibold text-text">{{ 'Tagline'|trans }}</dt>
                        <dd>{{ environment_settings['core.tagline'] ?? '–' }}</dd>
                    </div>
                    <div class="flex items-center justify-between gap-4">
                        <dt class="font-semibold text-text">{{ 'Support email'|trans }}</dt>
                        <dd>{{ environment_settings['core.support_email'] ?? '–' }}</dd>
                    </div>
                    <div class="flex items-center justify-between gap-4">
                        <dt class="font-semibold text-text">{{ 'Base URL'|trans }}</dt>
                        <dd>{{ environment_settings['core.url'] ?? '–' }}</dd>
                    </div>
                    <div class="flex items-center justify-between gap-4">
                        <dt class="font-semibold text-text">{{ 'Locale / Timezone'|trans }}</dt>
                        <dd>{{ environment_settings['core.locale'] ?? 'en' }} · {{ environment_settings['core.timezone'] ?? 'UTC' }}</dd>
                    </div>
                    <div class="flex items-center justify-between gap-4">
                        <dt class="font-semibold text-text">{{ 'User registration'|trans }}</dt>
                        <dd>{{ environment_settings['core.user_registration'] ? 'enabled'|trans : 'disabled'|trans }}</dd>
                    </div>
                    <div class="flex items-center justify-between gap-4">
                        <dt class="font-semibold text-text">{{ 'Maintenance mode'|trans }}</dt>
                        <dd>{{ environment_settings['core.maintenance_mode'] ? 'enabled'|trans : 'disabled'|trans }}</dd>
                    </div>
                </dl>
            {% endset %}

            {% include 'partials/components/card.html.twig' with {
                eyebrow: 'Environment',
                title: 'System defaults',
                body: environment_body
            } only %}

            {% set env_override_body %}
                <dl class="grid gap-2 text-sm leading-relaxed text-text-muted font-mono">
                    <div class="flex items-center justify-between gap-4">
                        <dt>APP_ENV</dt>
                        <dd>{{ environment_overrides.APP_ENV }}</dd>
                    </div>
                    <div class="flex items-center justify-between gap-4">
                        <dt>APP_DEBUG</dt>
                        <dd>{{ environment_overrides.APP_DEBUG }}</dd>
                    </div>
                    <div class="flex items-center justify-between gap-4">
                        <dt>APP_SECRET</dt>
                        <dd>{{ environment_overrides.APP_SECRET is empty ? 'will be generated'|trans : 'provided'|trans }}</dd>
                    </div>
                </dl>
            {% endset %}

            {% include 'partials/components/card.html.twig' with {
                eyebrow: '.env.local',
                title: 'Environment overrides',
                body: env_override_body
            } only %}

            {% set storage_body %}
                <p class="text-sm text-text-muted font-mono">{{ storage_config.root }}</p>
                <p class="text-xs text-text-muted">{{ 'Databases, uploads, snapshots, and backups will live inside this directory.'|trans }}</p>
            {% endset %}

            {% include 'partials/components/card.html.twig' with {
                eyebrow: 'Storage',
                title: 'Writable root',
                body: storage_body
            } only %}

            {% set admin_body %}
                <dl class="grid gap-2 text-sm leading-relaxed text-text-muted">
                    <div class="flex items-center justify-between gap-4">
                        <dt class="font-semibold text-text">{{ 'Email'|trans }}</dt>
                        <dd>{{ admin_account.email ?: '–' }}</dd>
                    </div>
                    <div class="flex items-center justify-between gap-4">
                        <dt class="font-semibold text-text">{{ 'Display name'|trans }}</dt>
                        <dd>{{ admin_account.display_name ?: '–' }}</dd>
                    </div>
                    <div class="flex items-center justify-between gap-4">
                        <dt class="font-semibold text-text">{{ 'Locale / Timezone'|trans }}</dt>
                        <dd>{{ admin_account.locale }} · {{ admin_account.timezone }}</dd>
                    </div>
                    <div class="flex items-center justify-between gap-4">
                        <dt class="font-semibold text-text">{{ 'Require MFA on first login'|trans }}</dt>
                        <dd>{{ admin_account.require_mfa ? 'yes'|trans : 'no'|trans }}</dd>
                    </div>
                    {% if admin_account.recovery_email %}
                        <div class="flex items-center justify-between gap-4">
                            <dt class="font-semibold text-text">{{ 'Recovery email'|trans }}</dt>
                            <dd>{{ admin_account.recovery_email }}</dd>
                        </div>
                    {% endif %}
                    {% if admin_account.recovery_phone %}
                        <div class="flex items-center justify-between gap-4">
                            <dt class="font-semibold text-text">{{ 'Recovery phone'|trans }}</dt>
                            <dd>{{ admin_account.recovery_phone }}</dd>
                        </div>
                    {% endif %}
                    <div class="flex items-center justify-between gap-4">
                        <dt class="font-semibold text-text">{{ 'Password'|trans }}</dt>
                        <dd>{{ admin_account.password ? 'provided'|trans : 'pending'|trans }}</dd>
                    </div>
                </dl>
            {% endset %}

            {% include 'partials/components/card.html.twig' with {
                eyebrow: 'Administrator',
                title: 'First user',
                body: admin_body
            } only %}

            {% if setup.databases_exist %}
                {% include 'partials/components/card.html.twig' with {
                    variant: 'warning',
                    title: 'Provisioning pending',
                    body: '<p class="text-sm text-text-muted">' ~ 'Database files exist, but the setup lock is missing. Finish the wizard to apply outstanding migrations and secure the installer.'|trans ~ '</p>'
                } only %}
            {% endif %}

            <div class="surface border border-border-strong rounded-md p-6 layout-stack layout-stack--tight">
                <div class="layout-stack layout-stack--tight">
                    <h2 class="text-heading text-xl">Finalize installation</h2>
                    <p class="text-sm text-text-muted">
                        {{ 'Provision the SQLite databases, apply Doctrine migrations, and lock this setup wizard.'|trans }}
                    </p>
                </div>
                <button
                    type="button"
                    class="btn btn-primary btn--lg self-start"
                    data-action-trigger
                    data-action-context="setup"
                    data-action-steps="{{ setup.action_steps|json_encode|e('html_attr') }}"
                    data-action-token="{{ setup.action_token|e('html_attr') }}"
                >
                    {{ 'Create databases & finish setup'|trans }}
                </button>
            </div>
        </div>

        <div class="layout-stack layout-stack--tight">
            {% include 'partials/components/illustration.html.twig' with {
                name: 'about-us-page',
                variant: 'lg',
                attributes: { class: 'w-full' },
                alt: 'Summary illustration'|trans
            } only %}

            {% include 'partials/components/card.html.twig' with {
                variant: 'muted',
                title: 'Need help?'|trans,
                body: '<p class="text-sm text-text-muted">' ~ 'Open the diagnostics sidebar or the command palette (coming soon) to jump directly to troubleshooting guides.'|trans ~ '</p>'
            } only %}
        </div>
    </div>

    {{ include('pages/installer/action.html.twig', { action_token: setup.action_token }) }}
{% endblock %}
