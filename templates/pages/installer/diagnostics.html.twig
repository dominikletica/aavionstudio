{% extends 'layouts/installer.html.twig' %}

{% block content %}
    {% include 'partials/components/section_heading.html.twig' with {
        title: 'installer.diagnostics.heading.title'|trans,
        subtitle: 'installer.diagnostics.heading.subtitle'|trans
    } only %}

    {% set summary_body %}
        <p class="text-sm leading-relaxed text-text">{{ 'installer.diagnostics.summary.php_version'|trans }} <strong>{{ diagnostics.php_version }}</strong></p>
    {% endset %}

    <div class="grid gap-6 lg:grid-cols-[minmax(0,2fr)_minmax(0,1fr)]">
        <div class="layout-stack layout-stack--loose">
            {% set rewrite_body %}
                <div class="layout-stack--tight text-sm leading-relaxed text-text">
                    <p>
                        {{ 'installer.diagnostics.rewrite.label'|trans }} <strong>{{ diagnostics.rewrite.enabled ? 'installer.diagnostics.rewrite.enabled'|trans : 'installer.diagnostics.rewrite.compatibility'|trans }}</strong>
                        {% if diagnostics.rewrite.mode == 'forced' %}
                            ({{ 'installer.diagnostics.rewrite.forced'|trans({ '%env%': '<code>APP_FORCE_ROOT_ENTRY</code>' })|raw }})
                        {% elseif not diagnostics.rewrite.enabled %}
                            – {{ 'installer.diagnostics.rewrite.fallback_notice'|trans }}
                        {% endif %}
                    </p>
                    {% if not diagnostics.rewrite.enabled and not diagnostics.rewrite.forced %}
                        {{ include('partials/components/alert.html.twig', {
                            variant: 'warning',
                            title: 'installer.diagnostics.rewrite.alert.title'|trans,
                            description: 'installer.diagnostics.rewrite.alert.description'|trans|raw,
                            attributes: { role: 'alert' }
                        }) }}
                        <p role="alert" class="sr-only">{{ 'installer.diagnostics.rewrite.alert.screen_reader'|trans }}</p>
                    {% elseif diagnostics.rewrite.mode == 'forced' %}
                        {{ include('partials/components/alert.html.twig', {
                            variant: 'info',
                            title: 'installer.diagnostics.rewrite.forced_title'|trans,
                            description: 'installer.diagnostics.rewrite.forced_description'|trans|raw
                        }) }}
                    {% endif %}
                    <dl class="grid gap-2 text-xs">
                        <div class="flex items-center justify-between gap-3">
                            <dt class="font-semibold text-text-muted">{{ 'installer.diagnostics.rewrite.effective_route'|trans }}</dt>
                            <dd><code>{{ diagnostics.rewrite.route }}</code></dd>
                        </div>
                        <div class="flex items-center justify-between gap-3">
                            <dt class="font-semibold text-text-muted">{{ 'installer.diagnostics.rewrite.original_uri'|trans }}</dt>
                            <dd><code>{{ diagnostics.rewrite.original_uri }}</code></dd>
                        </div>
                        <div class="flex items-center justify-between gap-3">
                            <dt class="font-semibold text-text-muted">{{ 'installer.diagnostics.rewrite.effective_uri'|trans }}</dt>
                            <dd><code>{{ diagnostics.rewrite.request_uri }}</code></dd>
                        </div>
                    </dl>
                </div>
            {% endset %}

            {% include 'partials/components/card.html.twig' with {
                title: 'installer.diagnostics.rewrite.card_title'|trans,
                subtitle: 'installer.diagnostics.rewrite.card_subtitle'|trans,
                body: rewrite_body,
                eyebrow: 'installer.diagnostics.rewrite.eyebrow'|trans
            } only %}

            {% set extension_rows = [] %}
            {% for extension in diagnostics.extensions %}
                {% set extension_rows = extension_rows|merge([{
                    label: extension.label,
                    status: extension.available ? 'installer.diagnostics.status.available'|trans : 'installer.diagnostics.status.missing'|trans,
                    hint: extension.available ? '—' : extension.hint
                }]) %}
            {% endfor %}

            {% include 'partials/components/card.html.twig' with {
                title: 'installer.diagnostics.extensions.title'|trans,
                subtitle: 'installer.diagnostics.extensions.subtitle'|trans,
                body: include('partials/components/table.html.twig', {
                    columns: [
                        { label: 'installer.diagnostics.extensions.column.extension'|trans, key: 'label', class: 'font-mono text-xs' },
                        { label: 'installer.diagnostics.extensions.column.status'|trans, key: 'status' },
                        { label: 'installer.diagnostics.extensions.column.hint'|trans, key: 'hint' }
                    ],
                    rows: extension_rows,
                    compact: true,
                    table_attributes: { 'data-testid': 'diagnostics-extensions' }
                }, with_context = false)|raw
            } only %}

            {% set filesystem_rows = [] %}
            {% for directory in diagnostics.filesystem %}
                {% set writable_text = directory.writable
                    ? 'ui.boolean.yes'|trans
                    : (directory.exists
                        ? (directory.parent_writable ? 'installer.diagnostics.filesystem.parent_writable'|trans : 'ui.boolean.no'|trans)
                        : 'ui.boolean.no'|trans)
                %}
                {% set filesystem_rows = filesystem_rows|merge([{
                    path: directory.path,
                    exists: directory.exists ? 'ui.boolean.yes'|trans : 'ui.boolean.no'|trans,
                    writable: writable_text,
                    hint: directory.writable ? '—' : directory.hint
                }]) %}
            {% endfor %}

            {% include 'partials/components/card.html.twig' with {
                title: 'installer.diagnostics.filesystem.title'|trans,
                subtitle: 'installer.diagnostics.filesystem.subtitle'|trans,
                body: include('partials/components/table.html.twig', {
                    columns: [
                        { label: 'installer.diagnostics.filesystem.column.directory'|trans, key: 'path', class: 'font-mono text-xs' },
                        { label: 'installer.diagnostics.filesystem.column.exists'|trans, key: 'exists', class: 'text-center' },
                        { label: 'installer.diagnostics.filesystem.column.writable'|trans, key: 'writable', class: 'text-center' },
                        { label: 'installer.diagnostics.filesystem.column.hint'|trans, key: 'hint' }
                    ],
                    rows: filesystem_rows,
                    compact: true,
                    table_attributes: { 'data-testid': 'diagnostics-filesystem' }
                }, with_context = false)|raw
            } only %}
        </div>

        <div class="layout-stack layout-stack--loose">
            {% include 'partials/components/card.html.twig' with {
                variant: 'emphasis',
                title: 'installer.diagnostics.environment.title'|trans,
                body: summary_body,
                eyebrow: 'installer.diagnostics.environment.eyebrow'|trans
            } only %}

            {% include 'partials/components/illustration.html.twig' with {
                name: 'active-support',
                variant: 'lg',
                attributes: { class: 'w-full' },
                alt: 'installer.diagnostics.illustration_alt'|trans
            } only %}

            {% set sqlite_body %}
                <dl class="grid gap-2 text-sm">
                    <div class="flex items-center justify-between gap-3">
                        <dt class="text-text-muted">{{ 'installer.diagnostics.sqlite.primary_path'|trans }}</dt>
                        <dd class="font-mono text-xs">{{ diagnostics.sqlite.primary_path ?: 'installer.diagnostics.not_applicable'|trans }}</dd>
                    </div>
                    <div class="flex items-center justify-between gap-3">
                        <dt class="text-text-muted">{{ 'installer.diagnostics.sqlite.secondary_path'|trans }}</dt>
                        <dd class="font-mono text-xs">{{ diagnostics.sqlite.secondary_path ?: 'installer.diagnostics.not_applicable'|trans }}</dd>
                    </div>
                    <div class="flex items-center justify-between gap-3">
                        <dt class="text-text-muted">{{ 'installer.diagnostics.sqlite.primary_exists'|trans }}</dt>
                        <dd>{{ diagnostics.sqlite.primary_exists ? 'ui.boolean.yes'|trans : 'ui.boolean.no'|trans }}</dd>
                    </div>
                    <div class="flex items-center justify-between gap-3">
                        <dt class="text-text-muted">{{ 'installer.diagnostics.sqlite.secondary_exists'|trans }}</dt>
                        <dd>{{ diagnostics.sqlite.secondary_exists ? 'ui.boolean.yes'|trans : 'ui.boolean.no'|trans }}</dd>
                    </div>
                    <div class="flex items-center justify-between gap-3">
                        <dt class="text-text-muted">{{ 'installer.diagnostics.sqlite.secondary_attached'|trans }}</dt>
                        <dd>{{ diagnostics.sqlite.secondary_attached ? 'ui.boolean.yes'|trans : 'ui.boolean.no'|trans }}</dd>
                    </div>
                    <div class="flex items-center justify-between gap-3">
                        <dt class="text-text-muted">{{ 'installer.diagnostics.sqlite.busy_timeout'|trans }}</dt>
                        <dd>{{ diagnostics.sqlite.busy_timeout_ms }}</dd>
                    </div>
                </dl>
            {% endset %}

            {% include 'partials/components/card.html.twig' with {
                title: 'installer.diagnostics.sqlite.title'|trans,
                body: sqlite_body,
                eyebrow: 'installer.diagnostics.sqlite.eyebrow'|trans
            } only %}

            {% include 'partials/components/help_entries.html.twig' with {
                entries: help['setup.diagnostics']|default([])
            } only %}
        </div>
    </div>

{% endblock %}
