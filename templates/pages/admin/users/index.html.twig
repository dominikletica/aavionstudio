{% extends 'layouts/admin.html.twig' %}

{% set admin_title = 'admin.users.page_title'|trans %}

{% block content %}
    {% include 'partials/components/section_heading.html.twig' with {
        title: 'admin.users.heading.title'|trans,
        subtitle: 'admin.users.heading.subtitle'|trans,
        actions: [
            {
                label: 'admin.users.heading.manage_invitations'|trans,
                tag: 'a',
                url: path('admin_user_invitations'),
                icon: 'mail',
            }
        ]
    } only %}

    <div class="layout-stack layout-stack--loose">
        {% set filter_form %}
            <form class="layout-stack layout-stack--tight" method="get" action="{{ path('admin_users_index') }}">
                <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                    {% include 'partials/forms/fields/input.html.twig' with {
                        id: 'admin-users-filter-q',
                        name: 'q',
                        label: 'admin.users.filters.search.label'|trans,
                        value: query,
                        placeholder: 'admin.users.filters.search.placeholder'|trans,
                        autocomplete: 'off'
                    } only %}

                    {% set statuses = [
                        { value: '', label: 'admin.users.filters.status.all'|trans },
                        { value: 'active', label: 'admin.users.status.active'|trans },
                        { value: 'pending', label: 'admin.users.status.pending'|trans },
                        { value: 'disabled', label: 'admin.users.status.disabled'|trans },
                        { value: 'archived', label: 'admin.users.status.archived'|trans }
                    ] %}

                    {% include 'partials/forms/fields/select.html.twig' with {
                        id: 'admin-users-filter-status',
                        name: 'status',
                        label: 'admin.users.filters.status.label'|trans,
                        value: status,
                        options: statuses
                    } only %}
                </div>
                <div class="flex justify-end gap-3">
                    {{ include('partials/components/button.html.twig', {
                        label: 'admin.users.filters.actions.clear'|trans,
                        variant: 'ghost',
                        tag: 'a',
                        url: path('admin_users_index')
                    }, with_context = false) }}
                    {{ include('partials/components/button.html.twig', {
                        label: 'admin.users.filters.actions.apply'|trans,
                        type: 'submit',
                        icon: 'filter'
                    }, with_context = false) }}
                </div>
            </form>
        {% endset %}

        {% include 'partials/components/card.html.twig' with {
            title: 'admin.users.filters.card_title'|trans,
            body: filter_form
        } only %}

        {% if users is empty %}
            {% include 'partials/components/card.html.twig' with {
                variant: 'muted',
                title: 'admin.users.empty.card_title'|trans,
                body: include('partials/components/empty_state.html.twig', {
                    title: 'admin.users.empty.title'|trans,
                    description: 'admin.users.empty.description'|trans,
                    actions: [
                        {
                            label: 'admin.users.empty.action'|trans,
                            tag: 'a',
                            url: path('admin_user_invitations'),
                            icon: 'mail'
                        }
                    ]
                }, with_context = false)|raw
            } only %}
        {% else %}
            {% set user_rows = [] %}
            {% for user in users %}
                {% set status_badge %}
                    <span class="badge badge--info">{{ ('admin.users.status.' ~ user.status)|trans }}</span>
                {% endset %}
                {% set roles_markup %}
                    {% if user.roles is empty %}
                        <span class="badge badge--info">{{ 'ROLE_VIEWER'|trans }}</span>
                    {% else %}
                        {% for role in user.roles %}
                            <span class="badge badge--info">{{ role|trans }}</span>
                        {% endfor %}
                    {% endif %}
                {% endset %}
                {% set actions_markup = include('partials/components/button.html.twig', {
                    label: 'admin.users.table.actions.edit'|trans,
                    tag: 'a',
                    size: 'sm',
                    variant: 'ghost',
                    icon: 'edit',
                    url: path('admin_users_edit', { id: user.id })
                }, with_context = false) %}
                {% set last_login = user.last_login_at ? user.last_login_at|format_datetime(pattern='region.datetime.short'|trans) : 'â€”' %}
                {% set user_rows = user_rows|merge([{
                    email: user.email,
                    name: user.display_name,
                    status: status_badge,
                    roles: roles_markup,
                    last_login: last_login,
                    actions: actions_markup
                }]) %}
            {% endfor %}

            {% include 'partials/components/card.html.twig' with {
                eyebrow: 'admin.users.table.eyebrow'|trans,
                title: 'admin.users.table.title'|trans,
                body: include('partials/components/table.html.twig', {
                    columns: [
                        { label: 'admin.users.table.columns.email'|trans, key: 'email', class: 'font-medium' },
                        { label: 'admin.users.table.columns.name'|trans, key: 'name' },
                        { label: 'admin.users.table.columns.status'|trans, key: 'status', template: 'partials/components/table/value_raw.html.twig' },
                        { label: 'admin.users.table.columns.roles'|trans, key: 'roles', template: 'partials/components/table/value_raw.html.twig' },
                        { label: 'admin.users.table.columns.last_login'|trans, key: 'last_login', class: 'whitespace-nowrap text-sm text-text-muted' },
                        { label: 'admin.users.table.columns.actions'|trans, key: 'actions', template: 'partials/components/table/value_raw.html.twig', class: 'text-right whitespace-nowrap' }
                    ],
                    rows: user_rows,
                    compact: true
                }, with_context = false)|raw
            } only %}
        {% endif %}
    </div>
{% endblock %}
