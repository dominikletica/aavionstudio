#!/usr/bin/env bash

set -euo pipefail

if [[ $# -lt 3 ]]; then
  echo "Usage: $(basename "$0") <environment> <version> <channel>" >&2
  echo "Example: $(basename "$0") prod 1.0.2 stable" >&2
  exit 1
fi

APP_ENV="$1"
VERSION="$2"
CHANNEL="$3"

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
BUILD_DIR="$ROOT_DIR/build"
STAGE_DIR="$BUILD_DIR/${APP_ENV}-${VERSION}-${CHANNEL}"
ZIP_NAME="aavionstudio-${VERSION}-${CHANNEL}.zip"
ZIP_PATH="$BUILD_DIR/$ZIP_NAME"
RELEASE_METADATA_PATH="$BUILD_DIR/manifest.json"
COMMIT_SHA="$(git -C "$ROOT_DIR" rev-parse --short HEAD)"
GENERATED_AT="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

echo ">>> Preparing release $VERSION ($CHANNEL) for environment '$APP_ENV'"

mkdir -p "$BUILD_DIR"

cat > "$RELEASE_METADATA_PATH" <<JSON
{
  "product": "aavion Studio",
  "version": "$VERSION",
  "channel": "$CHANNEL",
  "environment": "$APP_ENV",
  "git_commit": "$COMMIT_SHA",
  "generated_at": "$GENERATED_AT"
}
JSON

rm -rf "$STAGE_DIR"

EXCLUDES=(
  "--exclude=.git"
  "--exclude=.github"
  "--exclude=.gitignore"
  "--exclude=.gitmodules"
  "--exclude=compose.*"
  "--exclude=.codex"
  "--exclude=AGENTS.md"
  "--exclude=.phpunit.cache"
  "--exclude=node_modules"
  "--exclude=build"
  "--exclude=docs"
  "--exclude=tests"
  "--exclude=.env.local"
  "--exclude=.env.local.php"
  "--exclude=.env.*.local"
  "--exclude=.env.test"
  "--exclude=var"
  "--exclude=vendor"
  "--exclude=phpunit.dist.xml"
  "--exclude=public/assets"
)

echo ">>> Syncing repository into staging directory"
mkdir -p "$STAGE_DIR"
rsync -a --delete "${EXCLUDES[@]}" "$ROOT_DIR"/ "$STAGE_DIR"/

# The release package must remain cold. Never pre-initialise caches or databases.
# Ensure any stray runtime directories are gone (rsync excludes them, this is defensive).
rm -rf "$STAGE_DIR/var"
rm -rf "$STAGE_DIR/public/assets"

rm -f "$ZIP_PATH"

echo ">>> Creating archive $ZIP_NAME"
( cd "$STAGE_DIR" && zip -rq "$ZIP_PATH" . )

rm -rf "$STAGE_DIR"

echo ">>> Release package available at $ZIP_PATH"
