#!/usr/bin/env bash

set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

usage() {
  cat <<USAGE
Usage: $(basename "$0") [environment] [--setup] [--payload=/path/to/runtime.json]

Supported environments: dev, test, prod
If omitted, the environment defaults to "dev".
When `--setup` is provided, the script seeds installer payload data (expects `--payload`).
USAGE
}

MANIFEST_PATH="$ROOT_DIR/manifest.json"
MANIFEST_ENV=""
MANIFEST_PRODUCT=""
MANIFEST_VERSION=""
MANIFEST_CHANNEL=""

if [[ -f "$MANIFEST_PATH" ]]; then
  while IFS='=' read -r key value; do
    case "$key" in
      ENVIRONMENT) MANIFEST_ENV="$value" ;;
      PRODUCT) MANIFEST_PRODUCT="$value" ;;
      VERSION) MANIFEST_VERSION="$value" ;;
      CHANNEL) MANIFEST_CHANNEL="$value" ;;
    esac
  done < <(php -r '
    $path = $argv[1];
    $data = [];
    if (is_file($path)) {
        $json = file_get_contents($path);
        $data = json_decode($json, true) ?: [];
    }
    foreach (["environment", "product", "version", "channel"] as $key) {
        $value = $data[$key] ?? "";
        printf("%s=%s\n", strtoupper($key), $value);
    }
  ' "$MANIFEST_PATH")
fi

TARGET_ENV=""
SETUP_MODE=0
PAYLOAD_PATH=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --setup)
      SETUP_MODE=1
      shift
      ;;
    --payload=*)
      PAYLOAD_PATH="${1#--payload=}"
      shift
      ;;
    dev|test|prod)
      if [[ -z "$TARGET_ENV" ]]; then
        TARGET_ENV="$1"
        shift
      else
        echo "[init] Unknown argument: $1" >&2
        usage >&2
        exit 1
      fi
      ;;
    *)
      echo "[init] Unknown argument: $1" >&2
      usage >&2
      exit 1
      ;;
  esac
done

if [[ -z "$TARGET_ENV" ]]; then
  if [[ -n "$MANIFEST_ENV" ]]; then
    TARGET_ENV="$MANIFEST_ENV"
  else
    TARGET_ENV="dev"
  fi
fi

case "$TARGET_ENV" in
  dev)
    TARGET_DEBUG=1
    COMPOSER_FLAGS=(install --no-interaction --prefer-dist)
    ;;
  test)
    TARGET_DEBUG=1
    COMPOSER_FLAGS=(install --no-interaction --prefer-dist)
    ;;
  prod)
    TARGET_DEBUG=0
    COMPOSER_FLAGS=(install --no-interaction --prefer-dist --no-dev --optimize-autoloader --classmap-authoritative)
    ;;
  *)
    echo "[init] Unknown environment: $TARGET_ENV" >&2
    usage >&2
    exit 1
    ;;
esac

echo "[init] Welcome to ${MANIFEST_PRODUCT:-aavion Studio} (Version: ${MANIFEST_VERSION:-unknown}-${MANIFEST_CHANNEL:-unknown})!"
echo "[init] Starting initialization for environment '$TARGET_ENV'"

ENV_FILE=".env.local"
EXISTING_SECRET=""
EXISTING_PAYLOAD=""
DEFAULT_SECRET="DUMMY_SECRET_CHANGE_ME"
if [[ -f "$ENV_FILE" ]]; then
  EXISTING_SECRET="$(grep '^APP_SECRET=' "$ENV_FILE" | tail -n1 | cut -d'=' -f2- || true)"
  EXISTING_PAYLOAD="$(grep -vE '^(APP_ENV|APP_DEBUG|APP_SECRET|APP_PRODUCT_NAME|APP_VERSION|APP_CHANNEL)=' "$ENV_FILE" || true)"
fi

if [[ -n "${APP_SECRET:-}" ]]; then
  SECRET_VALUE="$APP_SECRET"
elif [[ "$TARGET_ENV" == "prod" ]]; then
  if [[ -z "$EXISTING_SECRET" || "$EXISTING_SECRET" == "$DEFAULT_SECRET" ]]; then
    SECRET_VALUE="$(php -r 'echo bin2hex(random_bytes(32));')"
  else
    SECRET_VALUE="$EXISTING_SECRET"
  fi
elif [[ -n "$EXISTING_SECRET" ]]; then
  SECRET_VALUE="$EXISTING_SECRET"
else
  SECRET_VALUE="$DEFAULT_SECRET"
fi

echo "[init] Writing $ENV_FILE"

cat > "$ENV_FILE" <<ENV
# Generated by bin/init on $(date -u +"%Y-%m-%dT%H:%M:%SZ")
APP_ENV=$TARGET_ENV
APP_DEBUG=$TARGET_DEBUG
APP_SECRET=$SECRET_VALUE
APP_PRODUCT_NAME="${MANIFEST_PRODUCT}"
APP_VERSION="${MANIFEST_VERSION}"
APP_CHANNEL="${MANIFEST_CHANNEL}"
ENV

if [[ -n "$EXISTING_PAYLOAD" ]]; then
  printf '\n%s\n' "$EXISTING_PAYLOAD" >> "$ENV_FILE"
fi

echo "[init] Installing Composer dependencies"
if ! output=$(COMPOSER_NO_INTERACTION=1 php bin/composer.phar "${COMPOSER_FLAGS[@]}" --no-progress --no-ansi --quiet 2>&1); then
  echo "[error] Composer install failed" >&2
  echo "$output" >&2
  exit 1
fi

ASSET_DIR="$ROOT_DIR/public/assets"
if [[ -d "$ASSET_DIR" ]]; then
  echo "[init] Clearing existing built assets"
  rm -rf "$ASSET_DIR"
fi
mkdir -p "$ASSET_DIR"

run_console() {
  local description="$1"
  shift
  echo "[init] $description"
  local output
  if ! output=$(APP_ENV="$TARGET_ENV" APP_DEBUG="$TARGET_DEBUG" SYMFONY_DEPRECATIONS_HELPER=never php bin/console "$@" --no-ansi --no-interaction --quiet 2>&1); then
      echo "[error] Command failed: php bin/console $*" >&2
      echo "$output" >&2
      exit 1
  fi
}

run_console "Rebuilding asset pipeline" app:assets:rebuild --force
# Fix: dbal throwing an error with --if-not-exists on SQLite, so we check for the DB file first
if [ ! -f var/system.brain ]; then
  echo "[init] Preparing SQLite database file"
  mkdir -p "$(dirname var/system.brain)"
  : > var/system.brain
fi
run_console "Running Database Migrations" doctrine:migrations:migrate --allow-no-migration
run_console "Ensuring Messenger transports exist" messenger:setup-transports

if [[ "$SETUP_MODE" -eq 1 ]]; then
  if [[ -n "$PAYLOAD_PATH" && ! -f "$PAYLOAD_PATH" ]]; then
    echo "[error] Payload file not found: $PAYLOAD_PATH" >&2
    exit 1
  fi

  if [[ -n "$PAYLOAD_PATH" ]]; then
    run_console "Seeding installer payload" app:setup:seed --payload="${PAYLOAD_PATH}"
  else
    run_console "Seeding installer payload" app:setup:seed
  fi
fi

echo "[init] Initialization complete for ${MANIFEST_PRODUCT:-aavion Studio} (Version: ${MANIFEST_VERSION:-unknown}-${MANIFEST_CHANNEL:-unknown})"
