#!/usr/bin/env bash

set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

usage() {
  cat <<USAGE
Usage: $(basename "$0") [environment] [--setup] [--payload=/path/to/runtime.json]

Supported environments: dev, test, prod
If omitted, the environment defaults to "dev".
When `--setup` is provided, the script seeds installer payload data (expects `--payload`).
USAGE
}

MANIFEST_PATH="$ROOT_DIR/manifest.json"
MANIFEST_ENV=""
MANIFEST_PRODUCT=""
MANIFEST_VERSION=""
MANIFEST_CHANNEL=""
MANIFEST_GENERATED_AT=""

if [[ -f "$MANIFEST_PATH" ]]; then
  while IFS='=' read -r key value; do
    case "$key" in
      ENVIRONMENT) MANIFEST_ENV="$value" ;;
      PRODUCT) MANIFEST_PRODUCT="$value" ;;
      VERSION) MANIFEST_VERSION="$value" ;;
      CHANNEL) MANIFEST_CHANNEL="$value" ;;
      GENERATED_AT) MANIFEST_GENERATED_AT="$value" ;;
    esac
  done < <(php -r '
    $path = $argv[1];
    $data = [];
    if (is_file($path)) {
        $json = file_get_contents($path);
        $data = json_decode($json, true) ?: [];
    }
    foreach (["environment", "product", "version", "channel", "generated_at"] as $key) {
        $value = $data[$key] ?? "";
        printf("%s=%s\n", strtoupper($key), $value);
    }
  ' "$MANIFEST_PATH")
fi

TARGET_ENV=""
SETUP_MODE=0
PAYLOAD_PATH=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --setup)
      SETUP_MODE=1
      shift
      ;;
    --payload=*)
      PAYLOAD_PATH="${1#--payload=}"
      shift
      ;;
    dev|test|prod)
      if [[ -z "$TARGET_ENV" ]]; then
        TARGET_ENV="$1"
        shift
      else
        echo "[init] Unknown argument: $1" >&2
        usage >&2
        exit 1
      fi
      ;;
    *)
      echo "[init] Unknown argument: $1" >&2
      usage >&2
      exit 1
      ;;
  esac
done

if [[ -z "$TARGET_ENV" ]]; then
  if [[ -n "$MANIFEST_ENV" ]]; then
    TARGET_ENV="$MANIFEST_ENV"
  else
    TARGET_ENV="dev"
  fi
fi

case "$TARGET_ENV" in
  dev)
    TARGET_DEBUG=1
    COMPOSER_FLAGS=(install --no-interaction --prefer-dist)
    ;;
  test)
    TARGET_DEBUG=1
    COMPOSER_FLAGS=(install --no-interaction --prefer-dist)
    ;;
  prod)
    TARGET_DEBUG=0
    COMPOSER_FLAGS=(install --no-interaction --prefer-dist --no-dev --optimize-autoloader --classmap-authoritative)
    ;;
  *)
    echo "[init] Unknown environment: $TARGET_ENV" >&2
    usage >&2
    exit 1
    ;;
esac

echo "[init] Welcome to ${MANIFEST_PRODUCT:-aavion Studio} (Version: ${MANIFEST_VERSION:-unknown}-${MANIFEST_CHANNEL:-unknown})!"
echo "[init] Starting initialization for environment '$TARGET_ENV'"

if [[ ! -f ".env" ]]; then
  echo "[error] Missing required file: .env" >&2
  exit 1
fi

if [[ ! -r ".env" ]]; then
  echo "[error] Unable to read .env (permission denied)" >&2
  exit 1
fi

ENV_FILE=".env.local"
DEFAULT_SECRET="DUMMY_SECRET_CHANGE_ME"

echo "[init] Writing $ENV_FILE"

ENV_TMP="$ENV_FILE.tmp"

php <<'PHP' "$ROOT_DIR" "$ENV_FILE" "$TARGET_ENV" "$TARGET_DEBUG" "$DEFAULT_SECRET" "${APP_SECRET:-}" "${MANIFEST_PRODUCT}" "${MANIFEST_VERSION}" "${MANIFEST_CHANNEL}" "${MANIFEST_GENERATED_AT}" > "$ENV_TMP"
<?php
[$projectDir, $envFile, $targetEnv, $targetDebug, $defaultSecret, $cliSecret, $manifestProduct, $manifestVersion, $manifestChannel, $manifestGeneratedAt] = $argv;

function parseEnvFile(string $path): array
{
    if (!is_file($path)) {
        return [];
    }

    $raw = file_get_contents($path);
    if ($raw === false) {
        return [];
    }

    $lines = preg_split('/\r\n|\r|\n/', $raw);
    $data = [];

    foreach ($lines as $line) {
        $line = trim((string) $line);

        if ($line === '' || $line[0] === '#') {
            continue;
        }

        if (!str_contains($line, '=')) {
            continue;
        }

        [$key, $value] = explode('=', $line, 2);
        $key = trim($key);
        $value = trim($value);

        if ($key === '') {
            continue;
        }

        if ($value !== '' && $value[0] === '"' && str_ends_with($value, '"')) {
            $value = stripcslashes(substr($value, 1, -1));
        }

        $data[$key] = $value;
    }

    return $data;
}

function formatEnvValue(string $value): string
{
    if ($value === '' || preg_match('/[\s"\'"'#=]/', $value)) {
        $escaped = str_replace(['\\', '"'], ['\\\\', '\"'], $value);

        return '"'.$escaped.'"';
    }

    return $value;
}

$baseEnv = parseEnvFile($projectDir.'/.env');
$localEnv = parseEnvFile($envFile);

$merged = $baseEnv;
foreach ($localEnv as $key => $value) {
    $merged[$key] = $value;
}

$merged['APP_ENV'] = $localEnv['APP_ENV'] ?? $targetEnv;
$merged['APP_DEBUG'] = $localEnv['APP_DEBUG'] ?? (string) ((int) $targetDebug);

$secretCandidates = array_filter([
    $cliSecret,
    $localEnv['APP_SECRET'] ?? null,
    $merged['APP_SECRET'] ?? null,
], fn (?string $value) use ($defaultSecret): bool => $value !== null && trim($value) !== '' && trim($value) !== $defaultSecret);

$secret = $secretCandidates[0] ?? null;

if ($secret === null) {
    if ($targetEnv === 'prod') {
        $secret = bin2hex(random_bytes(32));
    } elseif (isset($localEnv['APP_SECRET']) && trim($localEnv['APP_SECRET']) !== '') {
        $secret = trim($localEnv['APP_SECRET']);
    } elseif (isset($baseEnv['APP_SECRET']) && trim($baseEnv['APP_SECRET']) !== '') {
        $secret = trim($baseEnv['APP_SECRET']);
    } else {
        $secret = $defaultSecret;
    }
}

$merged['APP_SECRET'] = $secret;

foreach (['DATABASE_URL', 'APP_STORAGE_ROOT', 'MESSENGER_TRANSPORT_DSN', 'MAILER_DSN', 'LOCK_DSN'] as $key) {
    if (!isset($merged[$key]) && isset($baseEnv[$key])) {
        $merged[$key] = $baseEnv[$key];
    }
}

$merged['APP_PRODUCT_NAME'] = $manifestProduct;
$merged['APP_VERSION'] = $manifestVersion;
$merged['APP_CHANNEL'] = $manifestChannel;
$merged['APP_RELEASE_DATE'] = $manifestGeneratedAt;

ksort($merged);

$lines = ['# Generated by bin/init on '.gmdate('c')];

foreach ($merged as $key => $value) {
    $lines[] = $key.'='.formatEnvValue($value);
}

echo implode(PHP_EOL, $lines), PHP_EOL;
PHP

chmod 0640 "$ENV_TMP"
mv "$ENV_TMP" "$ENV_FILE"

echo "[init] Installing Composer dependencies"
if ! output=$(COMPOSER_NO_INTERACTION=1 php bin/composer.phar "${COMPOSER_FLAGS[@]}" --no-progress --no-ansi --quiet 2>&1); then
  echo "[error] Composer install failed" >&2
  echo "$output" >&2
  exit 1
fi

ASSET_DIR="$ROOT_DIR/public/assets"
if [[ -d "$ASSET_DIR" ]]; then
  echo "[init] Clearing existing built assets"
  rm -rf "$ASSET_DIR"
fi
mkdir -p "$ASSET_DIR"

run_console() {
  local description="$1"
  shift
  echo "[init] $description"
  local output
  if ! output=$(APP_ENV="$TARGET_ENV" APP_DEBUG="$TARGET_DEBUG" SYMFONY_DEPRECATIONS_HELPER=never php bin/console "$@" --no-ansi --no-interaction --quiet 2>&1); then
      echo "[error] Command failed: php bin/console $*" >&2
      echo "$output" >&2
      exit 1
  fi
}

run_console "Rebuilding asset pipeline" app:assets:rebuild --force

DATABASE_FILE=$(php <<'PHP' "$ROOT_DIR" "$ENV_FILE"
<?php
[$projectDir, $envFile] = $argv;

function parseEnv(string $path): array
{
    if (!is_file($path)) {
        return [];
    }

    $raw = file_get_contents($path);
    if ($raw === false) {
        return [];
    }

    $lines = preg_split('/\r\n|\r|\n/', $raw);
    $data = [];

    foreach ($lines as $line) {
        $line = trim((string) $line);

        if ($line === '' || $line[0] === '#') {
            continue;
        }

        if (!str_contains($line, '=')) {
            continue;
        }

        [$key, $value] = explode('=', $line, 2);
        $key = trim($key);
        $value = trim($value);

        if ($key === '') {
            continue;
        }

        if ($value !== '' && $value[0] === '"' && str_ends_with($value, '"')) {
            $value = stripcslashes(substr($value, 1, -1));
        }

        $data[$key] = $value;
    }

    return $data;
}

$env = parseEnv($envFile);
$url = $env['DATABASE_URL'] ?? '';

if ($url === '' || !str_starts_with($url, 'sqlite://')) {
    exit;
}

$path = substr($url, strlen('sqlite://'));
$path = ltrim($path, '/');

if ($path === '') {
    exit;
}

$path = '/'.$path;
$path = str_replace('%kernel.project_dir%', $projectDir, $path);
$path = str_replace(['\\'], '/', $path);

echo $path;
PHP
)

if [[ -n "$DATABASE_FILE" ]]; then
  if [ ! -f "$DATABASE_FILE" ]; then
    echo "[init] Preparing SQLite database file"
    mkdir -p "$(dirname "$DATABASE_FILE")"
    : > "$DATABASE_FILE"
  fi
fi
run_console "Running Database Migrations" doctrine:migrations:migrate --allow-no-migration
run_console "Ensuring Messenger transports exist" messenger:setup-transports

if [[ "$SETUP_MODE" -eq 1 ]]; then
  if [[ -n "$PAYLOAD_PATH" && ! -f "$PAYLOAD_PATH" ]]; then
    echo "[error] Payload file not found: $PAYLOAD_PATH" >&2
    exit 1
  fi

  if [[ -n "$PAYLOAD_PATH" ]]; then
    run_console "Seeding installer payload" app:setup:seed --payload="${PAYLOAD_PATH}"
  else
    run_console "Seeding installer payload" app:setup:seed
  fi
fi

echo "[init] Initialization complete for ${MANIFEST_PRODUCT:-aavion Studio} (Version: ${MANIFEST_VERSION:-unknown}-${MANIFEST_CHANNEL:-unknown})"
